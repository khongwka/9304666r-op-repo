#!/usr/bin/env bash
set -euo pipefail

export DEBIAN_FRONTEND=noninteractive

# 1. Ensure puppet, git, apache2, and curl are installed
apt-get update -y
apt-get install -y puppet git apache2 curl || true

# 2. Ensure apache2 package is installed via puppet
puppet resource package apache2 ensure=installed

# 3. Start and enable apache2 service via puppet
if ! puppet resource service apache2 ensure=running enable=true; then
  # Fallback if service command fails (minimal containers without systemd)
  mkdir -p /var/run/apache2
  nohup /usr/sbin/apache2ctl -D FOREGROUND >/var/log/apache2/fg.log 2>&1 &
  sleep 2
fi

# 4. Remove and recreate /operate/9304666r
puppet resource file /operate ensure=directory
puppet resource file /operate/9304666r ensure=absent
puppet resource file /operate/9304666r ensure=directory

# 5. Clone the GitHub repo into /operate/9304666r
if [ -d /operate/9304666r/.git ]; then
  git -C /operate/9304666r fetch --all
  git -C /operate/9304666r reset --hard origin/main
else
  git clone https://github.com/khongwka/9304666r-op-repo.git /operate/9304666r
fi

# 6. Backup existing index.html if present
SRC="/operate/9304666r/index-op-9304666r.html"
DST="/var/www/html/index.html"
if [ -f "$DST" ]; then
  cp -f "$DST" "${DST}.bak"
fi

# 7. Replace /var/www/html/index.html with index-op-9304666r.html via puppet
puppet resource file "$DST" ensure=file source="$SRC" owner='www-data' group='www-data' mode='0644'

# 8. Optional local test
curl -Is http://localhost | head -n 1 || true
